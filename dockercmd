#!/bin/bash -ex

./manage.py migrate
# exec ./manage.py runserver 0.0.0.0:8000

# poor man's cron
(
  while true; do
    ./manage.py clearsessions
    ./manage.py cleartokens
    sleep 444
  done
) &


# when running, always use gunicorn, to avoid
# > AssertionError: X is a "hop-by-hop" header;
# that comes from all uWSGI implementations (django server and waitress)
if [[ "$DEBUG" == "true" ]]; then
	    # --max-requests 1 \  # poor man's autoreload
	  exec gunicorn --reload \
	    --access-logfile '-' \
	    --error-logfile '-' \
	    --log-level 'info' \
	    --threads 20 \
	    --timeout 600 \
 	 -b 0.0.0.0:8000 \
 	 liquidcore.site.wsgi:application
else
	exec gunicorn \
	    --error-logfile '-' \
 	 --threads 20 \
	  --timeout 600 \
 	 -b 0.0.0.0:8000 \
 	 liquidcore.site.wsgi:application
fi
